<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honey Scraper Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-running {
            background: #27ae60;
            color: white;
        }

        .status-stopped {
            background: #95a5a6;
            color: white;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-bar input,
        .search-bar select {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .coupon-code {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }

        .country-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .country-badge {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .link {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
        }

        .link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üçØ Honey Scraper Dashboard</h1>
            <p>Monitor and control your Honey store data scraping</p>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Stats Grid -->
        <div class="grid">
            <div class="card">
                <h2>üìä Total Stores</h2>
                <div class="stat-value" id="totalStores">-</div>
                <div class="stat-label">stores in database</div>
            </div>
            <div class="card">
                <h2>üåç Domains Scraped</h2>
                <div class="stat-value" id="domainCount">-</div>
                <div class="stat-label">domains processed</div>
            </div>
            <div class="card">
                <h2>üéüÔ∏è Total Coupons</h2>
                <div class="stat-value" id="couponCount">-</div>
                <div class="stat-label">available coupons</div>
            </div>
            <div class="card">
                <h2>‚úÖ Active Stores</h2>
                <div class="stat-value" id="activeStores">-</div>
                <div class="stat-label">currently active</div>
            </div>
        </div>

        <!-- Scraper Control -->
        <div class="card">
            <h2>üéÆ Scraper Control</h2>
            <div style="margin-bottom: 15px;">
                Status: <span class="status-badge" id="scraperStatus">stopped</span>
                <span id="scraperInfo" style="margin-left: 10px; color: #666;"></span>
            </div>
            
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">0%</div>
                </div>
                <div style="color: #666; margin-top: 10px;">
                    <div>Current Domain: <strong id="currentDomain">-</strong></div>
                    <div>Domains: <strong id="domainsProgress">0 / 0</strong></div>
                    <div>Stores Saved: <strong id="storesSaved">0</strong></div>
                    <div>Errors: <strong id="errorsCount" style="color: #e74c3c;">0</strong></div>
                    <div id="consecutiveErrorsDiv" style="display: none; color: #e74c3c; font-weight: bold; margin-top: 5px;">
                        ‚ö†Ô∏è Consecutive Errors: <span id="consecutiveErrors">0</span> (May indicate rate limiting or blocking)
                    </div>
                    <div id="lastErrorDiv" style="display: none; color: #e74c3c; margin-top: 5px; font-size: 0.9em;">
                        Last Error: <span id="lastError">-</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showStartModal()">‚ñ∂Ô∏è Start Scraping</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopScraper()" disabled>‚èπÔ∏è Stop</button>
                <button class="btn btn-secondary" onclick="refreshStats()">üîÑ Refresh Stats</button>
                <button class="btn btn-secondary" onclick="exportData('csv')">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="exportData('json')">üì• Export JSON</button>
            </div>
        </div>

        <!-- Top Countries -->
        <div class="card">
            <h2>üåé Top Countries</h2>
            <div class="country-list" id="countryList"></div>
        </div>

        <!-- Stores Table -->
        <div class="card">
            <h2>üè™ Stores Database</h2>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search stores..." onkeyup="debounceSearch()">
                <select id="countryFilter" onchange="loadStores()">
                    <option value="">All Countries</option>
                </select>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="activeFilter" onchange="loadStores()">
                    Active Only
                </label>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Domain</th>
                            <th>Country</th>
                            <th>Shoppers (30d)</th>
                            <th>Coupons</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="storesTable">
                        <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Start Scraper Modal -->
    <div class="modal" id="startModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Start Scraping</h2>
                <span class="modal-close" onclick="closeModal('startModal')">&times;</span>
            </div>
            <div class="input-group">
                <label>Scraping Mode</label>
                <select id="scrapingMode" onchange="toggleDomainLimit()">
                    <option value="test">Test Mode (10 domains)</option>
                    <option value="limited">Limited (custom amount)</option>
                    <option value="resume">Resume (continue from where stopped)</option>
                    <option value="full">Full Scrape (all ~178k domains)</option>
                </select>
            </div>
            <div class="input-group" id="domainLimitGroup" style="display: none;">
                <label>Number of Domains</label>
                <input type="number" id="domainLimit" value="100" min="1">
            </div>
            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="skipExisting" checked>
                    Skip already scraped domains
                </label>
            </div>
            <button class="btn btn-success" onclick="startScraper()">Start</button>
            <button class="btn btn-secondary" onclick="closeModal('startModal')">Cancel</button>
        </div>
    </div>

    <!-- Store Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailStoreName">Store Details</h2>
                <span class="modal-close" onclick="closeModal('detailModal')">&times;</span>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let searchTimeout;
        let statusInterval;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStats();
            loadCountries();
            loadStores();
            startStatusPolling();
        });

        let lastStoreCount = 0;
        let lastErrorCount = 0;

        function startStatusPolling() {
            updateScraperStatus();
            statusInterval = setInterval(updateScraperStatus, 2000);
        }

        async function updateScraperStatus() {
            try {
                const response = await fetch('/api/scraper/status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    const isRunning = status.running;
                    
                    document.getElementById('scraperStatus').textContent = isRunning ? 'running' : 'stopped';
                    document.getElementById('scraperStatus').className = 'status-badge ' + (isRunning ? 'status-running' : 'status-stopped');
                    document.getElementById('stopBtn').disabled = !isRunning;
                    
                    if (isRunning) {
                        document.getElementById('progressContainer').style.display = 'block';
                        document.getElementById('scraperInfo').textContent = status.mode || '';
                        document.getElementById('currentDomain').textContent = status.current_domain || 'Starting...';
                        document.getElementById('domainsProgress').textContent = `${status.domains_processed} / ${status.total_domains}`;
                        document.getElementById('storesSaved').textContent = status.stores_saved;
                        document.getElementById('errorsCount').textContent = status.errors;
                        
                        // Show consecutive errors if > 0
                        const consecErrors = status.consecutive_errors || 0;
                        if (consecErrors > 0) {
                            document.getElementById('consecutiveErrorsDiv').style.display = 'block';
                            document.getElementById('consecutiveErrors').textContent = consecErrors;
                        } else {
                            document.getElementById('consecutiveErrorsDiv').style.display = 'none';
                        }
                        
                        // Show last error if exists
                        if (status.last_error) {
                            document.getElementById('lastErrorDiv').style.display = 'block';
                            document.getElementById('lastError').textContent = status.last_error;
                        } else {
                            document.getElementById('lastErrorDiv').style.display = 'none';
                        }
                        
                        const progress = status.total_domains > 0 ? (status.domains_processed / status.total_domains * 100) : 0;
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressBar').textContent = Math.round(progress) + '%';
                        
                        // Auto-refresh stats if stores or errors changed
                        if (status.stores_saved !== lastStoreCount || status.errors !== lastErrorCount) {
                            lastStoreCount = status.stores_saved;
                            lastErrorCount = status.errors;
                            refreshStats();
                            
                            // Reload table if on first page
                            if (currentPage === 1) {
                                loadStores(1);
                            }
                        }
                        
                        // Show error alerts
                        if (status.last_error && status.errors > lastErrorCount) {
                            showAlert('Scraping error: ' + status.last_error, 'error');
                        }
                        
                        // Check for consecutive errors (potential block)
                        if (status.consecutive_errors >= 5) {
                            showAlert(`‚ö†Ô∏è ${status.consecutive_errors} consecutive errors detected. Possible rate limit or block.`, 'error');
                        }
                    } else {
                        document.getElementById('progressContainer').style.display = 'none';
                        document.getElementById('scraperInfo').textContent = '';
                        
                        // Refresh stats when scraper stops
                        refreshStats();
                        loadStores(currentPage);
                    }
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function refreshStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('totalStores').textContent = stats.total_stores.toLocaleString();
                    document.getElementById('domainCount').textContent = stats.domains_scraped.toLocaleString();
                    document.getElementById('couponCount').textContent = stats.total_coupons.toLocaleString();
                    document.getElementById('activeStores').textContent = stats.active_stores.toLocaleString();
                    
                    // Update countries
                    const countryHtml = stats.top_countries.map(c => 
                        `<div class="country-badge">${c.country}: ${c.count.toLocaleString()}</div>`
                    ).join('');
                    document.getElementById('countryList').innerHTML = countryHtml;
                }
            } catch (error) {
                showAlert('Error loading stats: ' + error.message, 'error');
            }
        }

        async function loadCountries() {
            try {
                const response = await fetch('/api/countries');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('countryFilter');
                    select.innerHTML = '<option value="">All Countries</option>';
                    data.countries.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.country;
                        option.textContent = `${c.country} (${c.count})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        async function loadStores(page = 1) {
            currentPage = page;
            const search = document.getElementById('searchInput').value;
            const country = document.getElementById('countryFilter').value;
            const activeOnly = document.getElementById('activeFilter').checked;
            
            const params = new URLSearchParams({
                page: page,
                per_page: 50,
                search: search,
                country: country,
                active_only: activeOnly
            });
            
            try {
                const response = await fetch('/api/stores?' + params);
                const data = await response.json();
                
                if (data.success) {
                    renderStoresTable(data.stores);
                    renderPagination(data.pagination);
                }
            } catch (error) {
                showAlert('Error loading stores: ' + error.message, 'error');
            }
        }

        function renderStoresTable(stores) {
            const tbody = document.getElementById('storesTable');
            
            if (stores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No stores found</td></tr>';
                return;
            }
            
            tbody.innerHTML = stores.map(store => `
                <tr>
                    <td><strong>${store.name || 'N/A'}</strong></td>
                    <td>${store.domain || 'N/A'}</td>
                    <td>${store.country || 'N/A'}</td>
                    <td>${(store.shoppers_30d || 0).toLocaleString()}</td>
                    <td>${store.coupon_count || 0}</td>
                    <td>${store.active ? '‚úÖ Active' : '‚ùå Inactive'}</td>
                    <td>
                        <a href="#" class="link" onclick="showStoreDetail('${store.store_id}'); return false;">View Details</a>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            const pages = [];
            
            pages.push(`<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadStores(${pagination.page - 1})">Previous</button>`);
            
            for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) {
                pages.push(`<button ${i === pagination.page ? 'disabled' : ''} onclick="loadStores(${i})">${i}</button>`);
            }
            
            pages.push(`<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadStores(${pagination.page + 1})">Next</button>`);
            
            container.innerHTML = pages.join('');
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadStores(1), 500);
        }

        function showStartModal() {
            document.getElementById('startModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleDomainLimit() {
            const mode = document.getElementById('scrapingMode').value;
            document.getElementById('domainLimitGroup').style.display = mode === 'limited' ? 'block' : 'none';
        }

        async function startScraper() {
            const mode = document.getElementById('scrapingMode').value;
            const skipExisting = document.getElementById('skipExisting').checked;
            let maxDomains = null;
            
            if (mode === 'test') {
                maxDomains = 10;
            } else if (mode === 'limited') {
                maxDomains = parseInt(document.getElementById('domainLimit').value);
            }
            
            try {
                const response = await fetch('/api/scraper/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        max_domains: maxDomains,
                        skip_existing: skipExisting
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Scraper started successfully!', 'success');
                    closeModal('startModal');
                    setTimeout(refreshStats, 2000);
                } else {
                    showAlert('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error starting scraper: ' + error.message, 'error');
            }
        }

        async function stopScraper() {
            if (!confirm('Are you sure you want to stop the scraper?')) return;
            
            try {
                const response = await fetch('/api/scraper/stop', {method: 'POST'});
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Stop signal sent. Scraper will stop after current domain.', 'success');
                } else {
                    showAlert('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error stopping scraper: ' + error.message, 'error');
            }
        }

        async function showStoreDetail(storeId) {
            try {
                const response = await fetch(`/api/store/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    const store = data.store;
                    const coupons = data.coupons;
                    
                    document.getElementById('detailStoreName').textContent = store.name;
                    
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h3>Basic Information</h3>
                            <p><strong>Domain:</strong> ${store.domain}</p>
                            <p><strong>URL:</strong> <a href="${store.url}" target="_blank">${store.url}</a></p>
                            <p><strong>Country:</strong> ${store.country}</p>
                            <p><strong>Status:</strong> ${store.active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                            <p><strong>30-day Shoppers:</strong> ${(store.shoppers_30d || 0).toLocaleString()}</p>
                        </div>
                    `;
                    
                    if (coupons.length > 0) {
                        html += `<div style="margin-bottom: 20px;">
                            <h3>Coupons (${coupons.length})</h3>`;
                        coupons.forEach(coupon => {
                            html += `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <span class="coupon-code">${coupon.code}</span>
                                <span>${coupon.description || 'No description'}</span>
                                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                    Applied: ${coupon.applied_acc_count || 0} times
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('detailContent').innerHTML = html;
                    document.getElementById('detailModal').classList.add('active');
                } else {
                    showAlert('Error loading store details', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        function exportData(format) {
            window.location.href = `/api/export/${format}`;
            showAlert(`Exporting data as ${format.toUpperCase()}...`, 'success');
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
    </script>
</body>
</html>
